# シンプル雑貨オンライン詳細設計書（必須機能のみ）

※本バージョンは、基本設計の中から必須機能（商品閲覧、カート操作、非会員としての注文確定）の実装に絞った構成としています。

| ドキュメントバージョン | 1.0                                   |
| :------------------- | :------------------------------------ |
| 作成日               | 2025年4月6日                          |
| 作成チーム           | Jobs                        |
| 更新履歴             | 2025/04/06: Ver.1.0 初版作成 (Jobs) |

## 1. はじめに

### 1.1. 本書の目的

本書は、「シンプル雑貨オンライン」新規構築プロジェクトにおける詳細設計の内容を定義するものである。基本設計書 Ver.1.0 で定義された内容に基づき、実装担当者がプログラミング作業を迷いなく進められるように、システムの内部構造、処理フロー、インターフェース、データベース構造、画面項目などを具体的に記述する。

### 1.2. 前提となる基本設計書

本書は、以下の基本設計書の内容を前提とする。

   ECサイトシステム 基本設計書

### 1.3. 対象読者

本書は、以下の担当者を対象とする。

- 本システムのバックエンド開発担当者
- 本システムのフロントエンド開発担当者
- 本システムのテスト担当者
- プロジェクト管理者

### 1.4. 参考文献

- ECサイトシステム 基本設計書
- (チーム内で使用するコーディング規約などがあれば記載)

## 2. システム概要

システムの目的、対象ユーザー、全体構成、外部インターフェースについては、基本設計書の「2. システム概要」に記載の通りである。

**システム構成（再掲）**

<div class="mermaid">
graph LR
    subgraph ユーザー環境
        A[クライアント<br>（PC/スマホ ブラウザ）<br>HTML/CSS/JavaScript]
    end

    subgraph "バックエンド (ローカル or AWS)"
        subgraph "APIサーバー (Spring Boot)"
            direction LR
            B[Controller<br>] --> C(Service<br>);
            C --> D(Repository<br>);
        end
        subgraph DBサーバー
            E[データベース<br>（H2 / PostgreSQLなど）]
        end
        D --> E;
    end

    A -- ① APIリクエスト<br>(HTTP GET, POST...) --> B;
    B -- ② 処理依頼 --> C;
    C -- ③ データアクセス --> D;
    D -- ④ SQL実行 --> E;
    E -- ⑤ データ --> D;
    D -- ⑥ データ --> C;
    C -- ⑦ 処理結果 --> B;
    B -- ⑧ APIレスポンス<br>(JSONデータ) --> A;

    style A fill:#lightyellow,stroke:#333,stroke-width:1px
    style B fill:#lightblue,stroke:#333,stroke-width:1px
    style C fill:#lightgreen,stroke:#333,stroke-width:1px
    style D fill:#lightcoral,stroke:#333,stroke-width:1px
    style E fill:#lightgrey,stroke:#333,stroke-width:1px
</div>

## 3. 機能仕様

### 3.1. 機能一覧

#### 顧客向け機能

- F101:商品一覧表示
- F102:商品詳細表示
- F103:カート操作（追加・編集・削除）
- F104:注文情報入力
- F106:注文確定（完了画面／メール通知）

#### 管理者向け機能

- F201:商品登録・編集・削除
- F202:注文一覧・詳細確認・ステータス管理
- F203:簡易在庫確認
- F204:データ連携機能
    - CSVファイルによる情報一括登録機能
    - (オプション) 在庫不足通知メール送信機能

### 3.2. 機能詳細

主要機能における、ユーザー操作から始まるフロントエンドとバックエンドAPI間の連携、およびバックエンド内部のクラス間連携の概要をシーケンス図で示す。

（エラー処理の詳細は一部省略している。APIの詳細な仕様は「5. インターフェース仕様 (API)」を参照。）
#### 顧客向け機能
#### 3.2.1. 商品一覧表示機能 (F101)

ユーザーが商品一覧ページにアクセスした際の処理フローである。

<div class="mermaid">
sequenceDiagram
    participant User as ユーザー (ブラウザ)
    participant FE as フロントエンド (JS)
    participant ProductController
    participant ProductService
    participant ProductRepository
    participant DB as データベース

    User->>FE: 商品一覧ページへアクセス
    FE->>ProductController: GET /api/products
    ProductController->>ProductService: getAllProducts()
    ProductService->>ProductRepository: findAll()
    ProductRepository->>DB: SELECT * FROM products
    DB-->>ProductRepository: 商品データリスト
    ProductRepository-->>ProductService: List<Product>
    ProductService->>ProductService: ProductエンティティからProductListItem DTOへ変換
    ProductService-->>ProductController: List<ProductListItem>
    ProductController-->>FE: 商品リスト (JSON)
    FE-->>User: 商品一覧画面を表示
</div>

**補足:**

- まずは全件取得・表示を目指す。ページネーションは本演習の範囲外である。

#### 3.2.2. 商品詳細表示機能 (F102)

ユーザーが商品一覧から特定の商品を選択し、詳細ページを表示する際の処理フローである。

<div class="mermaid">
sequenceDiagram
    participant User as ユーザー (ブラウザ)
    participant FE as フロントエンド (JS)
    participant ProductController
    participant ProductService
    participant ProductRepository
    participant DB as データベース

    User->>FE: 商品一覧画面で特定の商品をクリック (商品ID)
    FE->>ProductController: GET /api/products/{productId}
    ProductController->>ProductService: getProductById(productId)
    ProductService->>ProductRepository: findById(productId)
    ProductRepository->>DB: SELECT * FROM products WHERE product_id = ?
    DB-->>ProductRepository: 商品データ (該当商品)
    ProductRepository-->>ProductService: Optional<Product>
    alt 商品が存在する場合
        ProductService->>ProductService: ProductエンティティからProductDetail DTOへ変換
        ProductService-->>ProductController: ProductDetail
        ProductController-->>FE: 商品詳細データ (JSON)
        FE-->>User: 商品詳細画面を表示
    else 商品が存在しない場合
        ProductService-->>ProductController: (エラー情報)
        ProductController-->>FE: 404 Not Found レスポンス
        FE-->>User: 商品が見つからない旨の表示
    end
</div>

#### 3.2.3. カート操作（追加・編集・削除）機能 (F103)

**カートに追加**
ユーザーが商品詳細ページで「カートに入れる」ボタンを押した際の処理フローである。カート情報はHTTPセッションで管理する。

<div class="mermaid">
sequenceDiagram
    participant User as ユーザー (ブラウザ)
    participant FE as フロントエンド (JS)
    participant CartController
    participant CartService
    participant ProductRepository
    participant HttpSession as HTTPセッション

    User->>FE: 商品詳細画面で「カートに入れる」クリック (商品ID, 数量)
    FE->>CartController: POST /api/cart (リクエストボディ: { productId: ..., quantity: ... })
    CartController->>CartService: addItemToCart(productId, quantity, httpSession)
    CartService->>ProductRepository: findById(productId)  // 商品存在確認・価格取得
    ProductRepository-->>CartService: Optional<Product>
    alt 商品が存在する場合
        CartService->>HttpSession: getAttribute("cart") // 現在のカート情報をセッションから取得
        HttpSession-->>CartService: Cartオブジェクト (存在しない場合はnull)
        CartService->>CartService: カートオブジェクトに商品を追加/数量更新
        CartService->>HttpSession: setAttribute("cart", updatedCart) // 更新したカート情報をセッションに保存
        CartService-->>CartController: 更新後のカート情報 (Cart DTO)
        CartController-->>FE: カート追加成功レスポンス (JSON: 更新後のカート情報)
        FE-->>User: カート追加完了メッセージ表示 / カートアイコン更新
    else 商品が存在しない場合
        CartService-->>CartController: (商品が見つからないエラー情報)
        CartController-->>FE: 404 Not Found レスポンス
        FE-->>User: エラーメッセージ表示
    end
</div>

**補足:**

- カートオブジェクト (`Cart`) やカート内アイテム (`CartItem`) のクラス設計は「4. クラス設計」で定義する。
- Spring Boot標準のHttpSession利用を基本とする。


**カートを編集・削除**
ユーザーがカートの中身を確認、数量変更、削除する際の処理フローである。

**カート情報取得 (GET /api/cart)**

<div class="mermaid">
sequenceDiagram
    participant User as ユーザー (ブラウザ)
    participant FE as フロントエンド (JS)
    participant CartController
    participant CartService
    participant HttpSession as HTTPセッション

    User->>FE: カートアイコンクリックなどでカート画面へ遷移指示
    FE->>CartController: GET /api/cart
    CartController->>CartService: getCart(httpSession)
    CartService->>HttpSession: getAttribute("cart")
    HttpSession-->>CartService: Cartオブジェクト (or null、空カートオブジェクト)
    CartService->>CartService: カート情報からCart DTOへ変換
    CartService-->>CartController: Cart DTO (カート情報)
    CartController-->>FE: カート情報 (JSON)
    FE-->>User: カート画面を表示
</div>

**カート数量変更 (PUT /api/cart/items/{itemId})**

<div class="mermaid">
sequenceDiagram
    participant User as ユーザー (ブラウザ)
    participant FE as フロントエンド (JS)
    participant CartController
    participant CartService
    participant HttpSession as HTTPセッション

    User->>FE: カート画面で数量変更 (アイテムID, 新しい数量)
    FE->>CartController: PUT /api/cart/items/{itemId} (リクエストボディ: { quantity: ... })
    CartController->>CartService: updateItemQuantity(itemId, quantity, httpSession)
    CartService->>HttpSession: getAttribute("cart")
    HttpSession-->>CartService: Cartオブジェクト
    CartService->>CartService: 指定されたアイテムの数量を更新
    CartService->>HttpSession: setAttribute("cart", updatedCart)
    CartService-->>CartController: 更新後のカート情報 (Cart DTO)
    CartController-->>FE: 更新成功レスポンス (JSON: 更新後のカート情報)
    FE-->>User: カート画面の表示更新
</div>

**カート商品削除 (DELETE /api/cart/items/{itemId})** (上記PUTと同様の流れ)

#### 3.2.4. 注文確定（完了画面／メール通知） (F106)

ユーザーが注文確認画面で「注文を確定する」ボタンを押した際の処理フローである。（非会員注文）

<div class="mermaid">
sequenceDiagram
    participant User as ユーザー (ブラウザ)
    participant FE as フロントエンド (JS)
    participant OrderController
    participant OrderService
    participant CartService
    participant ProductRepository
    participant OrderRepository
    participant EmailService
    participant HttpSession as HTTPセッション
    participant DB as データベース

    User->>FE: 注文確認画面で「注文を確定する」クリック
    FE->>OrderController: POST /api/orders (リクエストボディ: 注文者情報DTO)
    OrderController->>CartService: getCart(httpSession) // カート情報を取得
    CartService-->>OrderController: Cartオブジェクト

    alt カートが空でない場合
        OrderController->>OrderService: placeOrder(cart, orderRequestDto)
        OrderService->>OrderService: 入力値バリデーション
        OrderService->>ProductRepository: findById(productId) // 在庫確認 (ロックなし)
        ProductRepository->>DB: SELECT ...
        DB-->>ProductRepository: 商品情報リスト
        ProductRepository-->>OrderService: List<Product>
        alt 在庫あり
            OrderService->>ProductRepository: decreaseStock(productId, quantity) // 在庫減算
            ProductRepository->>DB: UPDATE products SET stock = stock - ? WHERE product_id = ? AND stock >= ?
            DB-->>ProductRepository: 更新結果 (件数)
            ProductRepository-->>OrderService: (成功/失敗)

            OrderService->>OrderService: 注文情報(Order)・注文明細(OrderDetail)エンティティ作成
            OrderService->>OrderRepository: save(order) // 注文情報保存
            OrderRepository->>DB: INSERT INTO orders ..., INSERT INTO order_details ...
            DB-->>OrderRepository: 保存結果
            OrderRepository-->>OrderService: 保存されたOrderエンティティ

            **OrderService->>EmailService: sendOrderConfirmationEmail(order, customerEmail)**
            **EmailService->>EmailService: メールテンプレート適用, メッセージ作成**
            **EmailService-->>OrderService: 送信結果**

            OrderService->>CartService: clearCart(httpSession) // カートを空にする
            CartService->>HttpSession: removeAttribute("cart")
            HttpSession-->>CartService: (完了)
            CartService-->>OrderService: (完了)

            OrderService->>OrderService: OrderResponse DTOへ変換
            OrderService-->>OrderController: OrderResponse DTO
            OrderController-->>FE: 201 Created レスポンス (JSON: { orderId: ... })
            FE-->>User: 注文完了画面表示
        else 在庫なし or DBエラー
            OrderService->>OrderService: (Rollback処理 - @Transactionalにより自動)
            OrderService-->>OrderController: エラー情報
            Controller-->>FE: 4xx or 5xx エラーレスポンス
            FE-->>User: エラーメッセージ表示
        end
    else カートが空の場合
        OrderController-->>FE: 400 Bad Request レスポンス
        FE-->>User: エラーメッセージ表示
    end
</div>

**補足:**

- `@Transactional` アノテーションを `OrderService#placeOrder` メソッドに付与し、DB操作の原子性を保証する。
- 在庫更新時のロック処理は本演習では実装しない。

#### 管理者向け機能

#### 3.2.5. 商品登録・編集・削除機能 (F201)

**商品登録フロー**
<div class="mermaid">
sequenceDiagram
    participant AdminUser as 管理者 (ブラウザ)
    participant FE as フロントエンド (管理画面JS)
    participant ProductController
    participant ProductService
    participant ProductRepository
    participant ImageStorage as 画像ストレージ
    participant DB as データベース

    AdminUser->>FE: 商品管理画面で「新規商品登録」ボタンクリック
    FE->>AdminUser: 商品登録・編集フォーム表示

    AdminUser->>FE: 必要項目入力 (name, description, price, stock, imasgeUrL, categoryId) と「登録」ボタンクリック
    FE->>ProductController: POST /api/admin/products (リクエストボディ: 商品情報DTO, 画像ファイル)
    ProductController->>ProductService: registerProduct(productDto, imageFile)

    ProductService->>ProductService: 入力値バリデーション (必須項目, 型, 範囲など)
    alt バリデーション成功
        ProductService->>ImageStorage: uploadImage(imageFile) // 画像をストレージにアップロード
        ImageStorage-->>ProductService: imageUrl (アップロードされた画像のURL)

        ProductService->>ProductService: Productエンティティ作成 (imageUrl含む)
        ProductService->>ProductRepository: save(productEntity) // 商品情報をDBに保存
        ProductRepository->>DB: INSERT INTO items ...
        DB-->>ProductRepository: 保存結果 (商品IDなど)
        ProductRepository-->>ProductService: 保存されたProductエンティティ

        ProductService-->>ProductController: 登録成功 (Product DTO)
        ProductController-->>FE: 201 Created レスポンス (JSON: 登録された商品情報)
        FE-->>AdminUser: 「商品が登録されました」メッセージ表示 / 商品管理一覧画面へ遷移
    else バリデーション失敗 or 画像アップロード失敗 or DBエラー
        ProductService-->>ProductController: エラー情報
        ProductController-->>FE: 4xx or 5xx エラーレスポンス
        FE-->>AdminUser: エラーメッセージ表示
    end
</div>

**商品編集フロー**
<div class="mermaid">
sequenceDiagram
    participant AdminUser as 管理者 (ブラウザ)
    participant FE as フロントエンド (管理画面JS)
    participant ProductController
    participant ProductService
    participant ProductRepository
    participant ImageStorage as 画像ストレージ
    participant DB as データベース

    AdminUser->>FE: 商品管理一覧画面で編集したい商品を選択 / 「編集」ボタンクリック
    FE->>ProductController: GET /api/admin/products/{productId}
    ProductController->>ProductService: getProductById(productId)
    ProductService->>ProductRepository: findById(productId)
    ProductRepository->>DB: SELECT * FROM items WHERE item_id = ?
    DB-->>ProductRepository: 商品情報
    ProductRepository-->>ProductService: Productエンティティ
    ProductService-->>ProductController: Product DTO
    ProductController-->>FE: 200 OK レスポンス (JSON: 取得した商品情報)
    FE->>AdminUser: 商品登録・編集フォームに既存情報を表示

    AdminUser->>FE: 項目変更 (例: 価格, 在庫数, 説明など) および「更新」ボタンクリック (必要であれば新しい画像ファイル)
    FE->>ProductController: PUT /api/admin/products/{productId} (リクエストボディ: 更新商品情報DTO, 新しい画像ファイル)
    ProductController->>ProductService: updateProduct(productId, productDto, newImageFile)

    ProductService->>ProductService: 入力値バリデーション
    alt バリデーション成功
        ProductService->>ProductRepository: findById(productId) // 更新対象の商品を取得
        ProductRepository->>DB: SELECT ...
        DB-->>ProductRepository: 既存商品情報
        ProductRepository-->>ProductService: ExistingProductEntity

        alt 新しい画像ファイルが提供された場合
            ProductService->>ImageStorage: deleteImage(oldImageUrl) // 古い画像をストレージから削除 (オプション)
            ImageStorage-->>ProductService: (完了)
            ProductService->>ImageStorage: uploadImage(newImageFile) // 新しい画像をストレージにアップロード
            ImageStorage-->>ProductService: newImageUrl
        end

        ProductService->>ProductService: ExistingProductEntityを更新 (新しい値とnewImageUrlで)
        ProductService->>ProductRepository: save(updatedProductEntity) // 商品情報をDBに保存 (更新)
        ProductRepository->>DB: UPDATE items SET ... WHERE item_id = ?
        DB-->>ProductRepository: 更新結果
        ProductRepository-->>ProductService: 更新されたProductエンティティ

        ProductService-->>ProductController: 更新成功 (Product DTO)
        ProductController-->>FE: 200 OK レスポンス (JSON: 更新された商品情報)
        FE-->>AdminUser: 「商品が更新されました」メッセージ表示 / 商品管理一覧画面へ遷移
    else バリデーション失敗 or 画像アップロード失敗 or DBエラー
        ProductService-->>ProductController: エラー情報
        ProductController-->>FE: 4xx or 5xx エラーレスポンス
        FE-->>AdminUser: エラーメッセージ表示
    end
</div>

**商品削除フロー**
<div class="mermaid">
sequenceDiagram
    participant AdminUser as 管理者 (ブラウザ)
    participant FE as フロントエンド (管理画面JS)
    participant ProductController
    participant ProductService
    participant ProductRepository
    participant ImageStorage as 画像ストレージ
    participant DB as データベース

    AdminUser->>FE: 商品管理一覧画面で削除したい商品を選択 / 「削除」ボタンクリック
    FE->>AdminUser: 削除確認ダイアログ表示 ("本当に削除しますか？")
    AdminUser->>FE: 「はい」を選択

    FE->>ProductController: DELETE /api/admin/products/{productId}
    ProductController->>ProductService: deleteProduct(productId)

    ProductService->>ProductRepository: findById(productId) // 削除対象の商品情報取得 (画像URLのため)
    ProductRepository->>DB: SELECT * FROM items WHERE item_id = ?
    DB-->>ProductRepository: Productエンティティ
    ProductRepository-->>ProductService: ProductEntity (取得できなかった場合はエラー)

    alt 商品が存在する場合
        ProductService->>ProductRepository: deleteById(productId) // DBから商品情報を削除
        ProductRepository->>DB: DELETE FROM items WHERE item_id = ?
        DB-->>ProductRepository: 削除結果

        ProductService->>ImageStorage: deleteImage(imageUrl) // 関連する画像をストレージから削除 (オプション)
        ImageStorage-->>ProductService: (完了)

        ProductService-->>ProductController: 削除成功
        ProductController-->>FE: 204 No Content (または 200 OK) レスポンス
        FE-->>AdminUser: 「商品が削除されました」メッセージ表示 / 商品管理一覧画面を更新
    else 商品が存在しない場合 or DBエラー
        ProductService-->>ProductController: エラー情報
        ProductController-->>FE: 404 Not Found or 5xx エラーレスポンス
        FE-->>AdminUser: エラーメッセージ表示
    end
</div>

#### 3.2.6. 注文一覧・詳細確認・ステータス管理機能 (F202)
**注文一覧確認フロー**
<div class="mermaid">
sequenceDiagram
    participant AdminUser as 管理者 (ブラウザ)
    participant FE as フロントエンド (管理画面JS)
    participant OrderController
    participant OrderService
    participant OrderRepository
    participant DB as データベース

    AdminUser->>FE: 管理メニューから「注文管理」を選択
    FE->>OrderController: GET /api/admin/orders (オプション: 検索条件, ページング情報)
    OrderController->>OrderService: getOrderList(searchCriteria, pagingInfo)

    OrderService->>OrderRepository: findAll(searchCriteria, pagingInfo) // 注文一覧をDBから取得
    OrderRepository->>DB: SELECT * FROM orders ... JOIN order_details ... WHERE ... ORDER BY ... LIMIT ... OFFSET ...
    DB-->>OrderRepository: 注文情報リスト
    OrderRepository-->>OrderService: List<Order>
    OrderService->>OrderService: 注文情報からOrderList DTOへ変換 (表示に必要な項目のみ)
    OrderService-->>OrderController: OrderList DTO

    OrderController-->>FE: 200 OK レスポンス (JSON: 注文一覧データ)
    FE-->>AdminUser: 注文管理一覧画面表示 (注文番号、注文日時、合計金額、ステータス、顧客名など)
</div>

**注文詳細確認フロー**
<div class="mermaid">
sequenceDiagram
    participant AdminUser as 管理者 (ブラウザ)
    participant FE as フロントエンド (管理画面JS)
    participant OrderController
    participant OrderService
    participant OrderRepository
    participant DB as データベース

    AdminUser->>FE: 注文管理一覧画面で、詳細を確認したい注文を選択 / クリック
    FE->>OrderController: GET /api/admin/orders/{orderId}
    OrderController->>OrderService: getOrderDetails(orderId)

    OrderService->>OrderRepository: findByIdWithDetails(orderId) // 注文IDで注文詳細（明細含む）をDBから取得
    OrderRepository->>DB: SELECT * FROM orders o JOIN order_details od ON o.order_id = od.order_id WHERE o.order_id = ?
    DB-->>OrderRepository: 注文詳細情報 (Order & OrderDetail)
    OrderRepository-->>OrderService: Optional<Order>
    
    alt 注文が存在する場合
        OrderService->>OrderService: 注文情報からOrderDetail DTOへ変換 (表示に必要な全ての項目)
        OrderService-->>OrderController: OrderDetail DTO
        OrderController-->>FE: 200 OK レスポンス (JSON: 注文詳細データ)
        FE-->>AdminUser: 注文管理詳細画面表示 (注文者情報, 配送先, 注文商品リスト, 各商品詳細, 合計金額, 現在のステータスなど)
    else 注文が存在しない場合
        OrderService-->>OrderController: (注文が見つからないエラー情報)
        OrderController-->>FE: 404 Not Found レスポンス
        FE-->>AdminUser: エラーメッセージ表示
    end
</div>

**注文ステータス確認フロー**
<div class="mermaid">
sequenceDiagram
    participant AdminUser as 管理者 (ブラウザ)
    participant FE as フロントエンド (管理画面JS)
    participant OrderController
    participant OrderService
    participant OrderRepository
    participant EmailService
    participant DB as データベース

    AdminUser->>FE: 注文管理詳細画面でステータス変更プルダウン選択 / 「更新」ボタンクリック (注文ID, 新しいステータス)
    FE->>OrderController: PUT /api/admin/orders/{orderId}/status (リクエストボディ: { status: ... })
    OrderController->>OrderService: updateOrderStatus(orderId, newStatus)

    OrderService->>OrderRepository: findById(orderId) // 更新対象の注文を取得
    OrderRepository->>DB: SELECT * FROM orders WHERE order_id = ?
    DB-->>OrderRepository: 注文情報
    ProductRepository-->>OrderService: Optional<Order>
    
    alt 注文が存在し、ステータス変更が可能
        OrderService->>OrderService: ステータス変更のバリデーション (例: 発送済みから受付中には戻せないなど)
        OrderService->>OrderRepository: updateStatus(orderId, newStatus) // データベースのステータスを更新
        OrderRepository->>DB: UPDATE orders SET order_status = ? WHERE order_id = ?
        DB-->>OrderRepository: 更新結果
        OrderRepository-->>OrderService: 更新されたOrderエンティティ

        alt ステータス変更に応じて顧客にメール通知が必要な場合 (例: 「発送済み」になった時)
            OrderService->>EmailService: sendStatusUpdateNotification(orderId, newStatus, customerEmail)
            EmailService->>EmailService: メールテンプレート適用, メッセージ作成
            EmailService-->>OrderService: 送信結果
        end

        OrderService-->>OrderController: 更新成功 (更新後のOrder DTO)
        OrderController-->>FE: 200 OK レスポンス (JSON: 更新された注文情報)
        FE-->>AdminUser: 「ステータスが更新されました」メッセージ表示 / 注文詳細画面を更新
    else 注文が存在しない、またはステータス変更が不正
        OrderService-->>OrderController: エラー情報
        Controller-->>FE: 4xx or 5xx エラーレスポンス
        FE-->>AdminUser: エラーメッセージ表示
    end
</div>
---

## 4. クラス設計

ここでは、「シンプル雑貨オンライン」バックエンド（Spring Boot）アプリケーションのクラス構造について定義する。主要なパッケージ構成、クラス図、主要クラスの説明、およびデータ転送オブジェクト（DTO）の定義を示す。

### 4.1. 主要パッケージ構成

ソースコードの整理と見通しを良くするため、以下のようなパッケージ構成を基本とする。ルートパッケージは `com.example.simplezakka` （仮）とする。

```
com.example.simplezakka
├── SimpleZakkaOnlineApplication.java  // Spring Boot起動クラス
│
├── controller      // HTTPリクエスト処理、APIエンドポイント定義
│   ├── ProductController.java
│   ├── CartController.java
│   └── OrderController.java
│
├── service         // ビジネスロジック実装
│   ├── ProductService.java
│   ├── CartService.java     // カート(セッション)操作ロジック
│   └── OrderService.java
│
├── repository      // データベースアクセス (Spring Data JPA)
│   ├── ProductRepository.java
│   ├── OrderRepository.java
│   └── OrderDetailRepository.java
│
├── entity          // DBテーブルに対応するJPAエンティティ
│   ├── Product.java
│   ├── Order.java
│   └── OrderDetail.java
│
├── dto             // Data Transfer Object (API入出力、レイヤー間データ転送用)
│   ├── product
│   │   ├── ProductListItem.java
│   │   └── ProductDetail.java
│   ├── cart
│   │   ├── Cart.java         // カート全体を表すDTO (セッション格納用でもある)
│   │   └── CartItem.java     // カート内商品を表すDTO
│   │   ├── CartItemInfo.java
│   │   └── CartItemQuantityDto.java
│   └── order
│       ├── OrderRequest.java
│       ├── CustomerInfo.java // OrderRequest内で使用 (非会員用)
│       └── OrderResponse.java
│
├── exception       // 例外ハンドリング
│   └── GlobalExceptionHandler.java // 基本的な例外ハンドリング
│
└── config
    └── DataLoader.java // サンプルデータロード用
```

**補足:**

- Service層のインターフェースと実装クラスの分離は不要。

### 4.2. クラス図

主要な機能ドメイン（商品、カート、注文）に関するクラスとその関連を示す。

#### 4.2.1. 商品関連クラス図

<div class="mermaid">
classDiagram
    class ProductController {
        +ProductService productService
        +getAllProducts() ResponseEntity~List~ProductListItem~~
        +getProductById(productId) ResponseEntity~ProductDetail~
    }
    class ProductService {
        +ProductRepository productRepository
        +findAllProducts() List~ProductListItem~
        +findProductById(productId) ProductDetail
    }
    class ProductRepository {
        <<Interface>>
        +JpaRepository~Product, Integer~
        +findAll() List~Product~
        +findById(productId) Optional~Product~
    }
    class Product {
        <<Entity>>
        +Integer productId
        +String name
        +String description
        +Integer price
        +Integer stock
        +String imageUrl
        +Boolean isRecommended "Nullable" // 必要に応じて
        +LocalDateTime createdAt "Nullable"
        +LocalDateTime updatedAt "Nullable"
    }
    class ProductListItem {
        <<DTO>>
        +Integer productId
        +String name
        +Integer price
        +String imageUrl
    }
    class ProductDetail {
        <<DTO>>
        +Integer productId
        +String name
        +Integer price
        +String description
        +Integer stock
        +String imageUrl
    }

    ProductController --> ProductService : uses
    ProductService --> ProductRepository : uses
    ProductRepository "1" -- "*" Product : manages
    ProductService ..> ProductListItem : creates
    ProductService ..> ProductDetail : creates
    ProductController ..> ProductListItem : returns
    ProductController ..> ProductDetail : returns
</div>

#### 4.2.2. カート関連クラス図 (セッション管理)

<div class="mermaid">
classDiagram
    class CartController {
        +CartService cartService
        +getCart(HttpSession) ResponseEntity~Cart~
        +addItem(CartItemInfo, HttpSession) ResponseEntity~Cart~
        +updateItem(itemId, CartItemQuantityDto, HttpSession) ResponseEntity~Cart~
        +removeItem(itemId, HttpSession) ResponseEntity~Cart~
    }
    class CartService {
        +ProductRepository productRepository
        +getCartFromSession(HttpSession) Cart
        +addItemToCart(productId, quantity, HttpSession) Cart
        +updateItemQuantity(itemId, quantity, HttpSession) Cart
        +removeItemFromCart(itemId, HttpSession) Cart
        +clearCart(HttpSession) void
    }
    class Cart {
        <<DTO/Session Object>>
        +Map~String, CartItem~ items
        +int totalQuantity
        +int totalPrice
        +addItem(product, quantity) void
        +updateQuantity(itemId, quantity) void
        +removeItem(itemId) void
        +calculateTotals() void
    }
    class CartItem {
        <<DTO/Session Object>>
        +String id  // カート内でのユニークID (例: productIdをString化)
        +Integer productId
        +String name
        +Integer price
        +String imageUrl
        +int quantity
        +int subtotal
    }
    class CartItemInfo{
        <<DTO>>
        +Integer productId
        +Integer quantity
    }
     class CartItemQuantityDto{
        <<DTO>>
        +Integer quantity
    }


    CartController --> CartService : uses
    CartService --> ProductRepository : uses (商品情報取得のため)
    CartService ..> Cart : manages (in Session)
    CartService ..> CartItem : uses
    Cart "1" *-- "items *" CartItem : contains
    CartController ..> Cart : returns
    CartController ..> CartItemInfo : receives
    CartController ..> CartItemQuantityDto : receives
</div>

#### 4.2.3. 注文関連クラス図 (非会員注文)

<div class="mermaid">
classDiagram
    class OrderController {
        +OrderService orderService
        +CartService cartService
        +placeOrder(OrderRequest, HttpSession) ResponseEntity~OrderResponse~
    }
    class OrderService {
        +OrderRepository orderRepository
        +OrderDetailRepository orderDetailRepository
        +ProductRepository productRepository
        +CartService cartService
        +placeOrder(Cart, OrderRequest) OrderResponse
    }
    class OrderRepository {
        <<Interface>>
        +JpaRepository~Order, Integer~
    }
     class OrderDetailRepository {
        <<Interface>>
        +JpaRepository~OrderDetail, Integer~
    }
    class Order {
        <<Entity>>
        +Integer orderId
        +LocalDateTime orderDate
        +Integer totalAmount
        +String customerName // 非会員用
        +String shippingAddress
        +String shippingPhoneNumber
        +String status
        +List~OrderDetail~ orderDetails
        +LocalDateTime createdAt "Nullable"
        +LocalDateTime updatedAt "Nullable"
    }
    class OrderDetail {
        <<Entity>>
        +Integer orderDetailId
        +Order order
        +Product product
        +String productName // 冗長
        +Integer price // 注文時点
        +Integer quantity
    }
    class OrderRequest {
        <<DTO>>
        +CustomerInfo customerInfo // 注文者情報(非会員用)
    }
    class CustomerInfo{
         <<DTO>>
        +String name
        +String email
        +String address
        +String phoneNumber
    }
    class OrderResponse {
        <<DTO>>
        +Integer orderId
        +LocalDateTime orderDate
    }

    OrderController --> OrderService : uses
    OrderController --> CartService : uses
    OrderService --> OrderRepository : uses
    OrderService --> OrderDetailRepository : uses
    OrderService --> ProductRepository : uses
    OrderService --> CartService : uses
    OrderRepository "1" -- "*" Order : manages
    OrderDetailRepository "1" -- "*" OrderDetail : manages
    Order "1" -- "*" OrderDetail : contains (Cascade PERSIST/MERGE)
    OrderDetail "n" -- "1" Order : belongs to
    OrderDetail "n" -- "1" Product : refers to

    OrderController ..> OrderRequest : receives
    OrderController ..> OrderResponse : returns
    OrderService ..> OrderResponse : creates
</div>

### 4.3. 主要クラス説明

各レイヤーのクラスの役割と、シンプル雑貨オンラインにおける代表的なクラス名は以下の通りである。

- **Controller (`@RestController`)**: フロントエンドからのHTTPリクエストを受け付け、Serviceを呼び出し、結果をJSON形式で返す責務を持つ。URLルーティング、リクエストデータの受け取りと基本的なバリデーション、レスポンスの生成を担当する。
    - 例: `ProductController`, `CartController`, `OrderController`
- **Service (`@Service`)**: アプリケーションのビジネスロジックを実装する責務を持つ。Controllerから依頼を受け、必要に応じて複数のRepositoryを操作し、結果をControllerに返す。基本的なトランザクション管理も主にこの層で行う。
    - 例: `ProductService`, `CartService`, `OrderService`
- **Repository (`@Repository`)**: データベースへのアクセス（基本的なCRUD操作）を担当するインターフェースである。Spring Data JPAを利用し、`JpaRepository`を継承することで基本的なDB操作メソッドが提供される。複雑なクエリの利用は最小限に留める。
    - 例: `ProductRepository`, `OrderRepository`, `OrderDetailRepository`
- **Entity (`@Entity`)**: データベースのテーブル構造にマッピングされるJavaオブジェクトである。テーブルのカラムに対応するフィールドを持ち、JPAのアノテーションが付与される。
    - 例: `Product`, `Order`, `OrderDetail`
- **DTO (Data Transfer Object)**: レイヤー間（特にControllerとService、APIの境界）でデータを転送するためのオブジェクトである。APIのリクエスト/レスポンス形式の定義にも使用される。
    - 例: `ProductListItem`, `ProductDetail`, `Cart`, `OrderRequest`, `OrderResponse`

### 4.4. DTO定義

主要なAPIや機能で使用されるDTOの構造を示す。 (バリデーションルールは簡略化)

**商品関連 DTO**

```java
// 商品一覧用
public class ProductListItem {
    private Integer productId;
    private String name;
    private Integer price;
    private String imageUrl;
    // getters, constructor
}

// 商品詳細用
public class ProductDetail {
    private Integer productId;
    private String name;
    private Integer price;
    private String description;
    private Integer stock;
    private String imageUrl;
    // getters, constructor
}
```

**カート関連 DTO**

```java
// カート全体 (セッション格納/APIレスポンス用)
public class Cart {
    private Map<String, CartItem> items = new LinkedHashMap<>();
    private int totalQuantity;
    private int totalPrice;
    // メソッド: addItem, updateQuantity, removeItem, calculateTotals など
    // getters
}

// カート内商品 (セッション格納/APIレスポンス用)
public class CartItem {
    private String id;
    private Integer productId;
    private String name;
    private Integer price;
    private String imageUrl;
    private int quantity;
    private int subtotal;
    // getters, setters, constructor
}

// カート追加APIリクエスト用
public class CartItemInfo {
    @NotNull
    private Integer productId;
    @NotNull @Min(1)
    private Integer quantity;
    // getters, setters
}

// カート数量更新APIリクエスト用
public class CartItemQuantityDto {
    @NotNull @Min(1)
    private Integer quantity;
    // getters, setters
}
```

**注文関連 DTO**

```java
// 注文APIリクエスト用
public class OrderRequest {
    @Valid // ネストしたDTOのバリデーションを有効化
    @NotNull
    private CustomerInfo customerInfo;
    // getters, setters
}

// 注文APIリクエスト内の顧客情報用 (非会員用)
public class CustomerInfo {
    @NotBlank
    private String name;
    @NotBlank @Email
    private String email;
    @NotBlank
    private String address;
    @NotBlank
    private String phoneNumber;
    // getters, setters
}

// 注文APIレスポンス用
public class OrderResponse {
    private Integer orderId;
    private LocalDateTime orderDate;
    // getters, constructor
}
```

**補足:**

- 上記DTOには、基本的なバリデーションのためのアノテーション (`@NotNull`, `@NotBlank`, `@Email`, `@Min`, `@Valid`) を付与している。Controller層での入力チェックに使用される。
- コンストラクタやGetter/Setterは記述を省略しているが、実際には必要（Lombokライブラリの使用も可）。

### 6 DB定義

### 6.1 データベース定義

## テーブル定義書

以下は、ER図と設計方針に基づいた各テーブルの定義を示したものです。

---

### CUSTOMER（顧客テーブル）
| 項目名        | データ型       | 主キー | NOT NULL | 説明                         |
|---------------|----------------|--------|-----------|------------------------------|
| customer_id   | VARCHAR(36)    | ○      | ○         | 顧客を一意に識別するID（UUID） |
| name          | VARCHAR(100)   |        | ○         | 顧客の名前                     |
| email         | VARCHAR(255)   |        | ○         | 顧客のメールアドレス             |
| address       | TEXT           |        | ○         | 顧客の住所                     |
| phone         | VARCHAR(20)    |        | ○         | 顧客の電話番号                  |
| created_at    | DATETIME       |        | ○         | 顧客情報の登録日時               |

**インデックス**: `email`（検索用）

---

### ADMIN_USER（管理者テーブル）
| 項目名         | データ型       | 主キー | NOT NULL | 説明                                |
|----------------|----------------|--------|-----------|-------------------------------------|
| admin_id       | VARCHAR(36)    | ○      | ○         | 管理者ID（UUID）                      |
| name           | VARCHAR(100)   |        | ○         | 管理者の名前                          |
| email          | VARCHAR(255)   |        | ○         | 管理者のメールアドレス                  |
| password_hash  | VARCHAR(255)   |        | ○         | ハッシュ化されたパスワード               |
| role_id        | VARCHAR(36)    |        | ○         | ROLEテーブルとの外部キー                 |

**インデックス**: `email`, `role_id`

---

### ROLE（ロールマスタ）
| 項目名     | データ型       | 主キー | NOT NULL | 説明                    |
|------------|----------------|--------|-----------|-------------------------|
| role_id    | VARCHAR(36)    | ○      | ○         | ロールID（UUID）         |
| role_name  | VARCHAR(100)   |        | ○         | ロール名（例：管理者）     |

---

### PRODUCT（商品マスタ）
| 項目名        | データ型       | 主キー | NOT NULL | 説明                               |
|---------------|----------------|--------|-----------|------------------------------------|
| product_id    | VARCHAR(36)    | ○      | ○         | 商品ID（UUID）                       |
| name          | VARCHAR(255)   |        | ○         | 商品名                              |
| description   | TEXT           |        |           | 商品説明                            |
| price         | INT            |        | ○         | 商品価格（税抜）                     |
| material      | VARCHAR(100)   |        |           | 素材                                |
| image_path    | VARCHAR(255)   |        |           | 商品画像の保存パスまたはURL             |
| category_id   | VARCHAR(36)    |        | ○         | CATEGORYテーブルとの外部キー             |
| created_at    | DATETIME       |        | ○         | 作成日時                             |
| updated_at    | DATETIME       |        | ○         | 最終更新日時                          |

**インデックス**: `category_id`, `name`

---

### CATEGORY（カテゴリマスタ）
| 項目名       | データ型       | 主キー | NOT NULL | 説明              |
|--------------|----------------|--------|-----------|-------------------|
| category_id  | VARCHAR(36)    | ○      | ○         | カテゴリID（UUID）  |
| name         | VARCHAR(100)   |        | ○         | カテゴリ名          |

---

### ORDER（注文テーブル）
| 項目名        | データ型       | 主キー | NOT NULL | 説明                            |
|---------------|----------------|--------|-----------|-------------------------------|
| order_id      | VARCHAR(36)    | ○      | ○         | 注文ID（UUID）                  |
| customer_id   | VARCHAR(36)    |        | ○         | CUSTOMERテーブルとの外部キー       |
| status_id     | VARCHAR(36)    |        | ○         | ORDER_STATUSテーブルとの外部キー |
| order_date    | DATETIME       |        | ○         | 注文日                          |

**インデックス**: `customer_id`, `status_id`

---

### ORDER_STATUS（注文ステータスマスタ）
| 項目名       | データ型       | 主キー | NOT NULL | 説明                      |
|--------------|----------------|--------|-----------|---------------------------|
| status_id    | VARCHAR(36)    | ○      | ○         | ステータスID（UUID）       |
| status_name  | VARCHAR(50)    |        | ○         | ステータス名（例：発送済み） |

---

### ORDER_ITEM（注文商品テーブル）
| 項目名       | データ型       | 主キー | NOT NULL | 説明                                 |
|--------------|----------------|--------|-----------|--------------------------------------|
| order_id     | VARCHAR(36)    | ○      | ○         | ORDERテーブルとの外部キー              |
| product_id   | VARCHAR(36)    | ○      | ○         | PRODUCTテーブルとの外部キー            |
| quantity     | INT            |        | ○         | 注文された商品の数量                    |
| unit_price   | INT            |        | ○         | 商品の注文時単価（税抜）               |

**インデックス**: `order_id`, `product_id`

### インデックス設計の留意点

- 更新頻度の高いカラムには慎重にインデックスを追加（INSERT/UPDATEのコスト増大）。

- 複合インデックス（例：(customer_id, order_date)）は使用パターンを分析してから設定。

### 6.2 ER図

<div class="mermaid">
erDiagram
    CUSTOMER ||--o{ ORDER : places
    ORDER ||--|{ ORDER_ITEM : contains
    PRODUCT }o--|| CATEGORY : categorized
    ADMIN_USER }o--|| ROLE : assigned
    ADMIN_USER ||--o{ PRODUCT : manages
    ORDER }o--|| ORDER_STATUS : has
 
    CUSTOMER {
        string customer_id PK
        string name
        string email
        string address
        string phone
        datetime created_at
    }
 
    PRODUCT {
        string product_id PK
        string name
        string description
        int price
        string material
        string image_path
        string category_id FK
        datetime created_at
        datetime updated_at
    }
 
    CATEGORY {
        string category_id PK
        string name
    }
 
    ORDER {
        string order_id PK
        string customer_id FK
        string status_id FK
        datetime order_date
    }
 
    ORDER_ITEM {
        string order_id FK
        string product_id FK
        int quantity
        int unit_price
    }
 
    ADMIN_USER {
        string admin_id PK
        string name
        string email
        string password_hash
        string role_id FK
    }
 
    ROLE {
        string role_id PK
        string role_name
    }
 
    ORDER_STATUS {
        string status_id PK
        string status_name
    }
</div>

### 6.3 トランザクション設計

<div class="mermaid">
sequenceDiagram
    participant C as 顧客
    participant FE as フロントエンド
    participant BE as バックエンド
    participant DB as データベース

    C->>FE: 商品を選択・カートに追加
    FE->>BE: カート内容を送信
    BE->>DB: 顧客情報を CUSTOMER に登録（存在しない場合）
    DB-->>BE: 顧客IDを返却
    BE->>DB: 注文を ORDER に登録（注文ID生成）
    DB-->>BE: 注文IDを返却
    loop 注文商品の数だけ
        BE->>DB: ORDER_ITEM に商品を登録（order_id, product_id, quantity, unit_price）
    end
    BE->>DB: ORDER_STATUS に初期ステータスを登録（例：未処理）
    BE-->>FE: 注文完了レスポンス（注文IDなど）
    FE-->>C: 完了画面表示
</div>

### トランザクション処理の説明

- ACIDトランザクションで管理：ORDER, ORDER_ITEM, CUSTOMER への挿入はすべて1つのトランザクション内で処理される。

- 顧客情報の重複登録を防ぐため、emailなどを条件に事前チェックを実施。

- 商品の価格や数量は注文時点で固定されるため、unit_priceはPRODUCTからコピーしてORDER_ITEMに保存。

- 処理が途中で失敗した場合はロールバックされ、整合性が保たれる。

---

## 7. 画面項目定義

### 7.1.画面一覧

| 画面ID | 画面名               | 概要説明                                                                 |
|--------|----------------------|--------------------------------------------------------------------------|
| S01    | トップページ         | ユーザーがサイトにアクセスした際に最初に表示される画面で、商品検索やおすすめ商品の一覧を提供します。 |
| S02    | 商品一覧画面         | 選択されたカテゴリや検索キーワードに応じた商品を一覧形式で表示する画面です。              |
| S03    | 商品詳細画面         | 選択した商品の詳細情報（画像・説明・価格など）を表示し、カート追加操作を行える画面です。      |
| S04    | カート画面           | ユーザーが選択した商品一覧を確認・編集（数量変更や削除）し、購入手続きに進むための画面です。   |
| S05    | 注文情報入力画面     | 顧客情報（氏名・住所・電話番号など）を入力し、注文に必要な情報を登録する画面です。         |
| S06    | 注文確認画面         | 入力済みの注文情報と購入内容を最終確認し、注文確定操作を行う画面です。                   |
| S07    | 注文完了画面         | 注文手続きが正常に完了したことを通知し、トップページへの遷移を促す画面です。              |
| A01    | 管理ログイン画面     | 管理者がシステムにログインするための認証情報を入力する画面です。                        |
| A02    | 商品管理画面         | 登録済み商品の一覧を管理者が確認し、編集・削除・新規追加へ遷移できる画面です。            |
| A03    | 商品登録／編集画面   | 商品情報（名称・カテゴリ・価格・画像など）を新規登録または編集するための管理者用画面です。   |
| A04    | 注文管理画面         | ユーザーからの注文履歴を管理者が一覧で確認し、各注文の詳細へアクセスできる画面です。       |
| A05    | 注文詳細画面         | 選択された注文の購入商品・金額・顧客情報などの詳細を管理者が確認できる画面です。           |


### 7.2.画面項目定義書


##### トップページ(S01)
| 項目名       | ラベル名       | UI部品 | データ型 | 入力 | 初期値 | サイズ | 文字種 | バリデーションルール | エラーメッセージ       |
|--------------|----------------|--------|----------|------|--------|--------|--------|----------------------|------------------------|
| メインバナー |                | 画像   | パス     | ×    | -      | -      | 半角英数 | 存在確認              | バナーが表示されません |
| 商品検索欄   | キーワード検索 | テキスト | 文字列 | ○    | -      | 50     | 全角/半角 | 文字数制限あり         | 入力が長すぎます       |
| 検索ボタン   | 検索           | ボタン  | -       | ○    | -      | -      | -      | クリックイベント      | 検索に失敗しました     |

##### 商品一覧画面(S02)

| 項目名          | ラベル名        | UI部品 | データ型      | 入力 | 初期値 | サイズ | 文字種     | バリデーションルール | エラーメッセージ       |
|-----------------|-----------------|--------|---------------|------|--------|--------|------------|----------------------|------------------------|
| 商品画像        |                 | 画像   | 文字列（パス） | ×    | -      | -      | 半角英数   | 存在確認              | 画像が表示できません    |
| 商品名          | 商品名          | テキスト | 文字列       | ×    | -      | 50     | 全角/半角  | -                    | -                      |
| 価格            | 価格（税込）    | テキスト | 数値         | ×    | -      | 10     | 半角数字   | 数値チェック          | 価格が不正です         |
| カート追加ボタン | カートに追加    | ボタン  | なし          | ○    | -      | -      | -          | クリックイベント      | 追加に失敗しました      |

##### 商品詳細画面(S03)

| 項目名     | ラベル名     | UI部品   | データ型  | 入力 | 初期値 | サイズ | 文字種   | バリデーションルール | エラーメッセージ         |
|------------|--------------|----------|----------|------|--------|--------|----------|----------------------|--------------------------|
| 商品画像    |              | 画像     | パス      | ×    | -      | -      | 半角英数 | 存在確認              | 商品画像が見つかりません |
| 商品名      | 商品名       | テキスト | 文字列   | ×    | -      | 50     | 全角/半角| -                    | -                        |
| 商品説明    | 説明         | テキスト | 文字列   | ×    | -      | 300    | 全角     | -                    | -                        |
| 素材        | 素材         | テキスト | 文字列   | ×    | -      | 100    | 全角     | -                    | -                        |
| カート追加ボタン | カートに追加 | ボタン  | -        | ○    | -      | -      | -        | -                    | 追加に失敗しました        |

##### カート画面(S05)

| 項目名     | ラベル名   | UI部品 | データ型 | 入力 | 初期値 | サイズ | 文字種 | バリデーションルール | エラーメッセージ            |
|------------|------------|--------|----------|------|--------|--------|--------|----------------------|-----------------------------|
| 商品名      | 商品名     | テキスト | 文字列 | ×    | -      | 50     | 全角   | -                    | -                           |
| 数量        | 数量       | 数値入力 | 数値   | ○    | 1      | 3      | 半角数字 | 数値チェック           | 数量が不正です             |
| 削除ボタン   | 削除       | ボタン  | -       | ○    | -      | -      | -      | クリックイベント      | 削除に失敗しました         |
| 合計金額    | 合計       | テキスト | 数値   | ×    | -      | 10     | 半角数字 | -                    | -                           |
| 注文手続きボタン | 注文手続き | ボタン  | -       | ○    | -      | -      | -      | -                    | 手続きに進めませんでした |

##### 注文情報入力画面(S06)

| 項目名     | ラベル名     | UI部品 | データ型 | 入力 | 初期値 | サイズ | 文字種 | バリデーションルール   | エラーメッセージ       |
|------------|--------------|--------|----------|------|--------|--------|--------|------------------------|--------------------------|
| 氏名        | 氏名         | テキスト | 文字列 | ○    | -      | 30     | 全角   | 必須                    | 氏名を入力してください     |
| 住所        | 配送先住所   | テキスト | 文字列 | ○    | -      | 100    | 全角   | 必須                    | 住所を入力してください     |
| 電話番号     | 電話番号     | テキスト | 数値   | ○    | -      | 15     | 半角数字 | 電話番号形式チェック     | 正しい電話番号を入力してください |

##### 注文確認画面(S07)

| 項目名     | ラベル名   | UI部品 | データ型 | 入力 | 初期値 | サイズ | 文字種 | バリデーションルール | エラーメッセージ          |
|------------|------------|--------|----------|------|--------|--------|--------|----------------------|---------------------------|
| 氏名        | 氏名       | テキスト | 文字列 | ×    | -      | 30     | 全角   | -                    | -                         |
| 住所        | 配送先住所 | テキスト | 文字列 | ×    | -      | 100    | 全角   | -                    | -                         |
| 電話番号     | 電話番号   | テキスト | 数値   | ×    | -      | 15     | 半角数字 | 電話番号形式チェック   | 電話番号が不正です        |
| 合計金額    | 合計金額   | テキスト | 数値   | ×    | -      | 10     | 半角数字 | -                    | -                         |
| 注文確定ボタン | 注文確定 | ボタン  | -       | ○    | -      | -      | -      | -                    | 確定できませんでした      |

##### 注文完了画面(S08)

| 項目名         | ラベル名       | UI部品 | データ型 | 入力 | 初期値 | サイズ | 文字種 | バリデーションルール | エラーメッセージ     |
|----------------|----------------|--------|----------|------|--------|--------|--------|----------------------|----------------------|
| 完了メッセージ  | 注文ありがとうございました | テキスト | 文字列 | ×    | -      | -      | 全角   | -                    | -                    |
| トップへ戻るボタン | トップへ       | ボタン  | -        | ○    | -      | -      | -      | -                    | -                    |

##### 管理ログイン画面(A01)

| 項目名     | ラベル名   | UI部品 | データ型 | 入力 | 初期値 | サイズ | 文字種 | バリデーションルール | エラーメッセージ         |
|------------|------------|--------|----------|------|--------|--------|--------|----------------------|--------------------------|
| ユーザーID  | ユーザーID | テキスト | 文字列 | ○    | -      | 30     | 半角   | 必須                  | ユーザーIDを入力してください |
| パスワード  | パスワード | パスワード | 文字列 | ○    | -      | 30     | 半角   | 必須                  | パスワードを入力してください |
| ログインボタン | ログイン   | ボタン  | -        | ○    | -      | -      | -      | -                    | ログインに失敗しました      |

##### 商品管理画面(A02)

| 項目名     | ラベル名     | UI部品 | データ型 | 入力 | 初期値 | サイズ | 文字種 | バリデーションルール | エラーメッセージ      |
|------------|--------------|--------|----------|------|--------|--------|--------|----------------------|-------------------------|
| 商品名      | 商品名       | テキスト | 文字列 | ×    | -      | 50     | 全角   | -                    | -                       |
| カテゴリ    | カテゴリ     | テキスト | 文字列 | ×    | -      | 30     | 全角   | -                    | -                       |
| 編集ボタン   | 編集         | ボタン  | -       | ○    | -      | -      | -      | -                    | 編集に失敗しました     |
| 削除ボタン   | 削除         | ボタン  | -       | ○    | -      | -      | -      | -                    | 削除に失敗しました     |

##### 商品登録／編集画面(A03)

| 項目名     | ラベル名     | UI部品 | データ型 | 入力 | 初期値 | サイズ | 文字種 | バリデーションルール | エラーメッセージ        |
|------------|--------------|--------|----------|------|--------|--------|--------|----------------------|-------------------------|
| 商品名      | 商品名       | テキスト | 文字列 | ○    | -      | 50     | 全角   | 必須                  | 商品名を入力してください |
| カテゴリ    | カテゴリ     | テキスト | 文字列 | ○    | -      | 30     | 全角   | 必須                  | カテゴリを入力してください |
| 価格        | 価格         | 数値入力 | 数値   | ○    | -      | 10     | 半角   | 数値チェック           | 価格が不正です           |
| 画像        | 商品画像     | ファイル | 画像ファイル | ○ | -   | -      | -      | 形式/サイズチェック    | 画像を選択してください   |

##### 注文管理画面(A04)

| 項目名     | ラベル名     | UI部品 | データ型 | 入力 | 初期値 | サイズ | 文字種 | バリデーションルール | エラーメッセージ     |
|------------|--------------|--------|----------|------|--------|--------|--------|----------------------|------------------------|
| 注文ID      | 注文ID       | テキスト | 数値   | ×    | -      | 10     | 半角   | -                    | -                      |
| 顧客名      | 顧客名       | テキスト | 文字列 | ×    | -      | 30     | 全角   | -                    | -                      |
| 日付        | 注文日       | テキスト | 日付   | ×    | -      | 10     | 半角   | -                    | -                      |
| 詳細ボタン   | 詳細         | ボタン  | -       | ○    | -      | -      | -      | -                    | 詳細表示に失敗しました |

##### 注文詳細画面(A05)

| 項目名     | ラベル名     | UI部品 | データ型 | 入力 | 初期値 | サイズ | 文字種 | バリデーションルール | エラーメッセージ     |
|------------|--------------|--------|----------|------|--------|--------|--------|----------------------|------------------------|
| 商品名      | 商品名       | テキスト | 文字列 | ×    | -      | 50     | 全角   | -                    | -                      |
| 数量        | 数量         | テキスト | 数値   | ×    | -      | 3      | 半角   | -                    | -                      |
| 小計        | 小計         | テキスト | 数値   | ×    | -      | 10     | 半角   | -                    | -                      |
| 合計金額    | 合計金額     | テキスト | 数値   | ×    | -      | 10     | 半角   | -                    | -                      |

### 7.3.入力チェック仕様

##### 注文情報入力画面
| 項目名     | バリデーションルール                                  | 実施場所   |
|------------|--------------------------------------------------------|------------|
| 氏名       | 必須入力、最大文字数50文字、全角/半角どちらも許容     | 両方       |
| 郵便番号   | 必須入力、半角数字7桁、正規表現：`^\d{3}-?\d{4}$`      | 両方       |
| 都道府県   | 必須入力、プルダウン選択制                             | クライアント |
| 市区町村   | 必須入力、最大50文字                                   | 両方       |
| 丁目・番地 | 任意入力、最大100文字                                  | サーバー   |
| 電話番号   | 必須入力、半角数字、正規表現：`^\d{10,11}$`            | 両方       |
| メールアドレス | 必須入力、形式チェック、最大100文字、RFC簡易準拠    | 両方       |
| 配送希望日 | 任意入力、過去日不可、未来30日以内                     | クライアント |
| 備考欄     | 任意入力、最大文字数500文字                             | サーバー   |


### 7.4.各画面の詳細なレイアウト
トップページ(S01)
![alt text](image.png)
商品一覧画面(S02)
![alt text](image-1.png)
商品詳細画面(S03)
![alt text](image-3.png)
カート画面(S04)
![alt text](image-5.png)
注文情報入力画面(S05)
![alt text](image-6.png)
注文確認画面(S06)
![alt text](image-7.png)
注文完了画面(S07)
![alt text](image-8.png)
管理ログイン画面(A01)
![alt text](image-9.png)
商品管理画面(A02)
![alt text](image-10.png)
商品登録/編集画面(A03)
![alt text](image-11.png)
注文管理画面(A04)
![alt text](image-12.png)
注文詳細画面(A05)
![alt text](image-13.png)


### 7.5.データ連携仕様
| 画面名         | イベント名             | 呼び出しAPIエンドポイント         | HTTPメソッド | リクエストパラメータ例                          | レスポンスデータ例                                | 備考 |
|----------------|------------------------|------------------------------------|---------------|--------------------------------------------------|----------------------------------------------------|------|
| トップページ     | 初期表示               | `/api/products`                   | GET          | なし                                             | `[ { "id": 1, "name": "商品A", "price": 1200 }, ... ]` | カテゴリ別に表示可能 |
| 商品詳細画面     | 商品クリック時           | `/api/products/{id}`              | GET          | `{ id: 123 }`                                   | `{ "id": 123, "name": "商品A", "description": "...", "price": 1200 }` |  |
| カート画面       | 商品追加ボタンクリック     | `/api/cart`                        | POST         | `{ "productId": 123, "quantity": 2 }`           | `{ "status": "ok" }`                               |  |
| カート画面       | 数量変更/削除           | `/api/cart/{id}`                  | PUT/DELETE   | `{ "quantity": 3 }` または `{}`                 | `{ "status": "updated" }`                         |  |
| 注文情報入力画面 | 入力内容送信             | `/api/order`                       | POST         | `{ "name": "...", "address": "...", ... }`      | `{ "orderId": 456 }`                               |  |
| 注文確認画面     | 注文確定ボタン押下時       | `/api/order/complete`             | POST         | `{ "orderId": 456 }`                            | `{ "status": "completed" }`                        | メール送信含む |
| 商品管理画面     | 初期表示（一覧取得）       | `/api/admin/products`             | GET          | なし                                             | `[ { "id": ..., "name": "...", "stock": ... }, ... ]` | 管理者認証後のみ |
| 商品登録画面     | 商品追加・編集            | `/api/admin/products`             | POST/PUT     | `{ "name": "商品A", "price": 1000, ... }`       | `{ "status": "success" }`                          |  |
| 注文管理画面     | 注文一覧取得             | `/api/admin/orders`               | GET          | なし                                             | `[ { "orderId": 456, "status": "完了" }, ... ]`     |  |
| 注文詳細画面     | 注文選択時               | `/api/admin/orders/{id}`          | GET          | `{ id: 456 }`                                   | `{ "orderId": 456, "items": [...], ... }`         |  |



---



## 8. 非機能要件詳細

### 8.1. 性能

本システムでは、以下の性能基準を目標とする。

- **画面応答時間**：商品一覧表示、商品詳細表示、カート表示、注文完了といった主要画面における処理応答時間は、通常時で **2秒以内** を目標とする。
- **同時接続数**：初期段階では想定同時アクセス数を **100〜200件程度** とし、この範囲内で安定したサービス提供が可能な構成とする。
- **拡張性配慮**：今後のアクセス数増加に備え、アプリケーションおよびデータベースのスケーラビリティを意識した構成とする。

**【詳細実装方針】**

- **データベース最適化**：
  - 商品一覧・検索機能などで使用されるカラムに対しインデックスを付与。
  - 複雑なJOINやサブクエリは極力避け、可能な場合はViewやキャッシュによる読み取り高速化を実施。
- **キャッシュの活用**：
  - RedisやMemcachedなどのインメモリキャッシュにより高速化。
- **画像表示最適化**：
  - CDN（例：Cloudflare）を介して配信。
  - サイズの自動圧縮とWebP形式での配信によりロード時間を短縮。
- **フロントエンドの工夫**：
  - Vue.js等のSPAフレームワークで不要なページ再読込を削減。
  - ページネーションやLazy Loadを用い、初期ロードのデータ量を制限。
- **非同期処理の導入**：
  - 在庫更新・注文履歴登録等の一部処理をLaravel Queuesなどで非同期化。
- **APMツールの導入**：
  - New RelicやDatadogなどを用いてボトルネックを随時分析可能にする。


### 8.2. セキュリティ

顧客の個人情報を取り扱うサービスとして、以下のセキュリティ対策を講じる。

- **通信の暗号化**：すべてのWeb通信は **HTTPS（TLS 1.2以上）** により暗号化。
- **入力値検証**：SQLインジェクションやXSSなどの脆弱性を防止するためのサーバーサイド検証を実装。
- **個人情報保護法の遵守**：適切な範囲で収集・利用・保管し、法令に従って管理。
- **SMTP認証情報の管理**：環境変数などで安全に管理し、ハードコードを避ける。

**【詳細実装方針】**

- **HTTPS対応**：
  - Let's Encrypt または AWS Certificate Manager による証明書を使用し、HTTPS通信を自動更新付きで常時適用。
  - HTTP → HTTPSリダイレクトを強制。
- **入力値検証・脆弱性対策**：
  - LaravelのValidation機能を用いてサニタイズ・バリデート。
  - Eloquent ORMやクエリビルダでSQLインジェクション対策。
  - Bladeテンプレートの自動エスケープ機能でXSS防止。
  - CSRFトークンを全フォームに付与。
- **パスワード管理と認証強化**：
  - bcryptでのハッシュ化保存。
  - レートリミットによる不正ログイン防止。
  - 管理者画面には2FA導入も検討。
- **SMTP情報の管理**：
  - `.env`ファイルにSMTP認証情報を格納し、コードから分離。
  - 環境別に`.env`ファイルを分けて漏洩リスクを低減。
- **ログ管理と監査**：
  - LaravelのMonologでログ分類（info, error, critical）。
  - 注文・登録などの重要操作は操作内容・ユーザーID・日時を記録。



### 8.3. 可用性

- **サービス稼働時間**：原則として、ECサイトは **24時間365日利用可能** なシステムとして設計。
- **障害時対応**：DBは **日次でバックアップ** を取得し、障害時に復旧可能とする。ログにより原因調査も実施。
- **クラウド基盤の活用**：柔軟な復旧・スケーリングが可能なクラウド構成とする。

**【詳細実装方針】**

- **クラウドインフラ構成（AWS）**：
  - EC2（Auto Scaling Group付き）
  - RDS（Multi-AZ構成）
  - S3（画像・CSV保管）
  - ALB（Application Load Balancer）
- **バックアップ設計**：
  - RDSスナップショットを毎日自動取得（7日間保存）
  - S3はバージョニング有効化
- **可用性監視**：
  - CloudWatchにより死活監視とアラート通知（メール・Slack）
  - 異常検知時は自動再起動・フェイルオーバー
- **フェイルオーバー設計**：
  - RDS自動フェイルオーバーによりスタンバイDBへ切替
  - EC2はAuto Scaling Groupで自動再起動
- **ログの集中管理**：
  - CloudWatch LogsやOpenSearch Serviceでログ集約
  - タイムスタンプ・ユーザーID・リクエストパス・エラーレベルを記録


### 8.4. その他（保守性・拡張性）

- **モジュール設計の採用**：機能追加を容易にする疎結合モジュール構成。
- **管理画面のGUI化**：非エンジニアでも運用可能な管理者機能をGUIで実装。
- **ログと監査記録**：操作ログを記録し、調査や内部統制に備える。
- **レスポンシブ対応**：各端末で快適に操作できるようデザイン対応。

**【詳細実装方針】**

- **モジュール構成例**：
  - `/modules/product/`：商品機能
  - `/modules/order/`：注文・在庫機能
  - `/modules/user/`：ユーザー機能
  - APIと画面を分離し再利用性を高める。
- **管理画面の構築**：
  - Vue.jsまたはReactでSPA構成
  - GUIで商品登録・注文管理などを操作可能
  - 入力補助やバリデーションチェックを整備
- **ログ・監査記録**：
  - 例：
    - 商品登録 → `{"type": "product_create", "admin_id": 101, "product_id": 1009, "timestamp": "2025-07-03T10:45:00"}`
    - 注文確定 → `{"type": "order_confirm", "user_id": 202, "order_id": 3001, "timestamp": "2025-07-03T11:05:00"}`
  - CloudWatch Logsに送信・アクセス制限付きで保管
- **レスポンシブ対応**：
  - Tailwind CSSやBootstrap 5を使用
  - モバイルファースト設計、主要解像度での検証実施
  - スムーズなカート操作・注文処理を実現




